<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DIPCO Dashboard Admin</title>

<!-- Librairies externes -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
  /* ===== Global & Apple-like design ===== */
  :root {
    --accent: #007aff;
    --accent-dark: #0062cc;
    --success: #34c759;
    --danger: #ff3b30;
    --warning: #ffcc00;
    --bg-light: #f5f5f7;
    --bg-card: #ffffff;
    --text-primary: #1d1d1f;
    --text-secondary: #8e8e93;
    --border-color: #d1d1d6;
    --card-radius: 12px;
    --transition: 180ms cubic-bezier(.2,.9,.2,1);
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  
  html, body {
    height: 100%;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background-color: var(--bg-light);
    color: var(--text-primary);
  }
  
  body {
    padding: 20px;
  }
  
  .wrap {
    max-width: 1400px;
    margin: 0 auto;
  }
  
  /* Header */
  header.topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-color);
  }
  
  .branding {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  
  .branding img {
    height: 48px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }
  
  /* Cards */
  .card {
    background-color: var(--bg-card);
    border-radius: var(--card-radius);
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    padding: 24px;
    margin-bottom: 20px;
    border: 1px solid var(--border-color);
  }
  
  /* Stats */
  .stats {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    margin-bottom: 24px;
  }
  
  .stat {
    flex: 1;
    min-width: 180px;
    padding: 18px;
    border-radius: 12px;
    background-color: var(--bg-card);
    border: 1px solid var(--border-color);
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
  }
  
  .stat .label {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 6px;
  }
  
  .stat .value {
    font-size: 24px;
    font-weight: 600;
    color: var(--text-primary);
  }
  
  /* Buttons */
  .btn {
    padding: 10px 16px;
    border-radius: 10px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: var(--transition);
    border: none;
    font-size: 14px;
  }
  
  .btn-primary {
    background-color: var(--accent);
    color: white;
  }
  
  .btn-primary:hover {
    background-color: var(--accent-dark);
  }
  
  .btn-secondary {
    background-color: transparent;
    color: var(--accent);
    border: 1px solid var(--border-color);
  }
  
  .btn-secondary:hover {
    background-color: rgba(0, 0, 0, 0.03);
  }
  
  .btn-excel {
    background: linear-gradient(to right, #217346, #1a5c37);
    color: white;
  }
  
  .btn-excel:hover {
    background: linear-gradient(to right, #1a5c37, #13482d);
  }
  
  .btn-danger {
    background-color: var(--danger);
    color: white;
  }
  
  .btn-danger:hover {
    background-color: #e63a30;
  }
  
  /* Controls */
  .controls {
    display: flex;
    gap: 12px;
    align-items: center;
    margin: 20px 0;
    flex-wrap: wrap;
  }
  
  .search {
    position: relative;
    flex: 1 1 320px;
  }
  
  .search input {
    width: 100%;
    padding: 12px 16px 12px 42px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    background-color: var(--bg-card);
    color: var(--text-primary);
    outline: none;
    transition: var(--transition);
    font-size: 14px;
  }
  
  .search input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
  }
  
  .search i {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
  }
  
  /* Filters */
  .filters {
    display: flex;
    gap: 12px;
    align-items: center;
  }
  
  .select, .input {
    background-color: var(--bg-card);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    padding: 10px 12px;
    border-radius: 10px;
    outline: none;
    font-size: 14px;
  }
  
  .select:focus, .input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
  }
  
  /* Table */
  .table-wrap {
    overflow: auto;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    margin-top: 16px;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1200px;
  }
  
  thead th {
    position: sticky;
    top: 0;
    background-color: #f8f8f8;
    color: var(--text-primary);
    padding: 16px;
    text-align: left;
    font-size: 14px;
    font-weight: 600;
    border-bottom: 1px solid var(--border-color);
  }
  
  tbody td {
    padding: 16px;
    color: var(--text-primary);
    border-bottom: 1px solid var(--border-color);
    font-size: 14px;
  }
  
  tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
  }
  
  .tag {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    background-color: #f0f0f0;
    color: var(--text-primary);
    font-weight: 500;
  }
  
  /* Actions */
  .actions {
    display: flex;
    gap: 8px;
  }
  
  .actions button {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .actions button:hover {
    background: rgba(0, 0, 0, 0.05);
    color: var(--text-primary);
  }
  
  /* Modals */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  
  .modal-box {
    width: 100%;
    max-width: 800px;
    background-color: var(--bg-card);
    border-radius: 14px;
    padding: 24px;
    border: 1px solid var(--border-color);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
  }
  
  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }
  
  .modal-title {
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
  }
  
  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
  }
  
  .form-grid .full {
    grid-column: 1/3;
  }
  
  label {
    font-size: 14px;
    color: var(--text-primary);
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
  }
  
  input[type="text"], input[type="number"], textarea, select {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    background-color: var(--bg-card);
    color: var(--text-primary);
    outline: none;
    font-size: 15px;
  }
  
  input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
  }
  
  .modal-footer {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 24px;
  }
  
  /* Toasts */
  .toast-wrap {
    position: fixed;
    right: 20px;
    top: 20px;
    z-index: 1200;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .toast {
    min-width: 280px;
    padding: 16px;
    border-radius: 10px;
    background-color: var(--bg-card);
    color: var(--text-primary);
    border-left: 4px solid var(--success);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    display: flex;
    gap: 12px;
    align-items: center;
    animation: slideIn 0.3s ease-out;
  }
  
  .toast.warn {
    border-left-color: var(--warning);
  }
  
  .toast.err {
    border-left-color: var(--danger);
  }
  
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  /* Utilities */
  .muted {
    color: var(--text-secondary);
    font-size: 14px;
  }
  
  .right {
    margin-left: auto;
  }
  
  .kbd {
    background: rgba(0, 0, 0, 0.05);
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 13px;
    color: var(--text-secondary);
  }
  
  .value-cell {
    font-weight: 500;
    color: var(--accent);
  }
  
  .excel-icon {
    color: #217346;
  }

  /* Batch Table Styles */
  .batch-table-container {
    overflow-x: auto;
    margin: 20px 0;
  }
  
  .batch-table {
    width: 100%;
    border-collapse: collapse;
  }
  
  .batch-table th {
    background-color: #f8f8f8;
    padding: 12px 15px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid var(--border-color);
  }
  
  .batch-table td {
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
  }
  
  .batch-table input {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
  }
  
  .batch-table .actions-cell {
    text-align: center;
  }
  
  .batch-table .remove-btn {
    color: var(--danger);
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2rem;
  }
  
  .batch-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
  }
  
  .batch-add-row {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--accent);
    cursor: pointer;
    font-weight: 500;
  }
  
  .batch-info {
    background-color: #f1f3f5;
    border-radius: 8px;
    padding: 16px;
    margin-top: 20px;
    display: flex;
    gap: 12px;
  }
  
  @media (max-width: 992px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
    
    .stats {
      flex-direction: column;
    }
    
    .search {
      flex-basis: 100%;
    }
    
    .batch-footer {
      flex-direction: column;
      gap: 15px;
      align-items: flex-start;
    }
    
    .batch-save {
      align-self: flex-end;
    }
  }
</style>
</head>
<body>
  <div class="wrap">
    <header class="topbar">
      <div class="branding">
        <img src="https://dipco.itxpress.net/dipco_logo.png" alt="logo">
        <div>
          <div style="font-weight:700;font-size:22px;color:var(--text-primary)">DIPCO Dashboard Admin</div>
          <div class="muted">Gestion des Articles & Prix</div>
        </div>
      </div>
      <div class="muted">Auto-refresh: <span id="autoRefreshTxt">5min</span></div>
    </header>

    <!-- Stats + controls -->
    <section class="card">
      <div class="stats">
        <div class="stat">
          <div class="label">Articles</div>
          <div class="value" id="statCount">0</div>
        </div>
        <div class="stat">
          <div class="label">Prix moyen ($)</div>
          <div class="value" id="statAvg">-</div>
        </div>
        <div class="stat">
          <div class="label">Total valeur ($)</div>
          <div class="value" id="statTotal">-</div>
        </div>
        <div class="stat">
          <div class="label">Valeur moyenne ($)</div>
          <div class="value" id="statValueAvg">-</div>
        </div>
      </div>

      <div class="controls">
        <div class="search">
          <i class="fas fa-search"></i>
          <input id="searchInput" placeholder="Recherche par code, description, type, demar..." />
        </div>

        <div class="filters">
          <select id="filterType" class="select">
            <option value="">Filtrer par Type</option>
          </select>
          <select id="filterDemar" class="select">
            <option value="">Filtrer par Démarque</option>
          </select>

          <div style="display:flex;gap:12px;align-items:center;">
            <button id="btnAdd" class="btn btn-secondary"><i class="fas fa-plus"></i> Ajouter</button>
            <button id="btnBatch" class="btn btn-excel"><i class="fas fa-layer-group"></i> Ajout en lot</button>
            <button id="btnExport" class="btn btn-secondary"><i class="fas fa-file-export"></i> Export</button>
            <button id="btnRefresh" class="btn btn-secondary" title="Forcer refresh"><i class="fas fa-sync-alt"></i></button>
          </div>
        </div>
      </div>
    </section>

    <!-- Table -->
    <section class="card">
      <div class="table-wrap">
        <table id="articlesTable">
          <thead>
            <tr>
              <th data-key="code" class="sortable">Code <i class="fas fa-sort"></i></th>
              <th data-key="description" class="sortable">Description <i class="fas fa-sort"></i></th>
              <th data-key="demar" class="sortable">Demar <i class="fas fa-sort"></i></th>
              <th data-key="prix_vente" class="sortable">Prix ($) <i class="fas fa-sort"></i></th>
              <th data-key="achat_minimum" class="sortable">Achat <i class="fas fa-sort"></i></th>
              <th>Valeur ($)</th>
              <th data-key="unite" class="sortable">Unité <i class="fas fa-sort"></i></th>
              <th data-key="type" class="sortable">Type <i class="fas fa-sort"></i></th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <!-- Rempli par JS -->
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Modal ARTICLE (Add / Edit) -->
  <div id="modalArticle" class="modal-backdrop" style="display:none;">
    <div class="modal-box">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Ajouter un article</div>
        <button onclick="closeArticleModal()" class="btn btn-secondary">Fermer</button>
      </div>

      <form id="articleForm">
        <input type="hidden" id="articleId" />
        <div class="form-grid">
          <div>
            <label>Code *</label>
            <input id="f_code" type="text" required />
            <div class="muted" style="margin-top:6px">Ex: W0110-F4-08</div>
          </div>
          <div>
            <label>Type *</label>
            <input id="f_type" type="text" required />
          </div>
          <div class="full">
            <label>Description *</label>
            <textarea id="f_description" rows="2" required></textarea>
          </div>
          <div>
            <label>Prix Vente ($) *</label>
            <input id="f_prix_vente" type="number" step="0.01" min="0" required />
          </div>
          <div>
            <label>Achat Minimum ($)</label>
            <input id="f_achat_minimum" type="number" step="0.01" min="0" />
          </div>
          <div>
            <label>Valeur ($)</label>
            <input id="f_valeur" type="text" readonly />
          </div>
          <div>
            <label>Unité</label>
            <input id="f_unite" type="text" />
          </div>
          <div>
            <label>Démarque</label>
            <input id="f_demar" type="text" />
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeArticleModal()">Annuler</button>
          <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Enregistrer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal BATCH (nouveau design) -->
  <div id="modalBatch" class="modal-backdrop" style="display:none;">
    <div class="modal-box">
      <div class="modal-header">
        <div class="modal-title">Ajout en lot</div>
        <button onclick="closeBatchModal()" class="btn btn-secondary">Fermer</button>
      </div>

      <div>
        <h3 style="font-size: 18px; margin-bottom: 16px;">Édition en lot</h3>
        <p class="muted" style="margin-bottom: 20px;">Ajoutez ou modifiez plusieurs articles simultanément</p>
        
        <div class="batch-table-container">
          <table class="batch-table">
            <thead>
              <tr>
                <th class="required">CODE</th>
                <th class="required">DESCRIPTION</th>
                <th>DEMAR</th>
                <th>PRIX ($)</th>
                <th>ACHAT MIN.</th>
                <th>UNITÉ</th>
                <th>TYPE</th>
                <th>ACTIONS</th>
              </tr>
            </thead>
            <tbody id="batch-items-table">
              <!-- Rempli dynamiquement -->
            </tbody>
          </table>
        </div>
        
        <div class="batch-footer">
          <div class="batch-add-row" id="batch-add-row">
            <i class="fas fa-plus-circle"></i>
            <span>Ajouter ligne</span>
          </div>
          <div class="batch-save">
          <!--  <div class="kbd">Entrée</div> -->
            <button class="btn btn-excel" id="batch-save-all">
              <i class="fas fa-save"></i> Enregistrer tout
            </button>
          </div>
        </div>
        
        <div class="batch-info">
          <i class="fas fa-info-circle" style="color: var(--accent); font-size: 24px;"></i>
          <div>
            <h4 style="font-weight: 600; margin-bottom: 8px;">Conseils pour l'ajout en lot</h4>
            <p class="muted">Commencez à taper dans les champs pour voir les suggestions basées sur les valeurs existantes. Appuyez sur Entrée pour passer à la cellule suivante.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-wrap" id="toasts"></div>

<script>
/*
  DIPCO Dashboard Admin
  - CRUD articles with API at /api/admin/articles
  - Features: search, filters, sort, add, edit, delete, batch add, export, toasts, auto-refresh
*/

/* ================= Configuration ================= */
const API_BASE = '/api/admin/articles';
const AUTO_REFRESH_MS = 5 * 60 * 1000; // 5 minutes
let autoRefreshTimer = null;

/* ================= State ================= */
let articles = [];          // full list from server
let filtered = [];          // after search/filters/sort
let sortState = { key: null, dir: 1 }; // dir: 1 asc, -1 desc
let allUnits = [];          // unités existantes
let allTypes = [];          // types existants

/* ================= Utils ================= */
function authHeaders() {
  return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token') || ''}` };
}

function toast(message, type='success', timeout=3500){
  const el = document.createElement('div');
  el.className = 'toast ' + (type === 'success' ? '' : (type === 'err' ? 'err' : 'warn'));
  el.innerHTML = `
    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'err' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle'}"></i>
    <div style="flex:1">${message}</div>
    <button style="background:transparent;border:none;color:var(--text-secondary);cursor:pointer" onclick="this.closest('.toast').remove()">
      <i class="fas fa-times"></i>
    </button>
  `;
  document.getElementById('toasts').appendChild(el);
  if(timeout) setTimeout(()=> el.remove(), timeout);
}

function formatCurrency(v) {
  if (v === null || v === undefined || isNaN(v)) return '';
  return Number(v).toLocaleString('fr-FR', {minimumFractionDigits:2, maximumFractionDigits:2});
}

/* ================= Rendering ================= */

function renderTable(list = filtered) {
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  
  if(!list.length){
    tbody.innerHTML = `
      <tr>
        <td colspan="9" style="text-align:center;padding:40px;color:var(--text-secondary)">
          <i class="fas fa-inbox" style="font-size:48px;margin-bottom:16px;opacity:0.3"></i>
          <div>Aucun article trouvé</div>
        </td>
      </tr>
    `;
    return;
  }
  
  list.forEach(a => {
    const valeur = (Number(a.prix_vente) || 0) * (Number(a.achat_minimum) || 0);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(a.code)}</td>
      <td>${escapeHtml(a.description)}</td>
      <td>${escapeHtml(a.demar || '')}</td>
      <td>${formatCurrency(a.prix_vente)}</td>
      <td>${formatCurrency(a.achat_minimum)}</td>
      <td class="value-cell">${formatCurrency(valeur)}</td>
      <td>${escapeHtml(a.unite || '')}</td>
      <td><span class="tag">${escapeHtml(a.type || '')}</span></td>
      <td class="actions">
        <button title="Éditer" onclick="openEdit('${a.id}')"><i class="fas fa-edit"></i></button>
        <button title="Supprimer" onclick="deleteArticle('${a.id}')"><i class="fas fa-trash" style="color:var(--danger)"></i></button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ================= Filters / Search / Sort ================= */

function applyFiltersSortSearch(){
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  const fType = document.getElementById('filterType').value;
  const fDemar = document.getElementById('filterDemar').value;

  filtered = articles.filter(a => {
    if(fType && ((a.type||'').toLowerCase() !== fType.toLowerCase())) return false;
    if(fDemar && ((a.demar||'').toLowerCase() !== fDemar.toLowerCase())) return false;

    if(!q) return true;
    return (a.code && a.code.toLowerCase().includes(q)) ||
           (a.description && a.description.toLowerCase().includes(q)) ||
           (a.type && a.type.toLowerCase().includes(q)) ||
           (a.demar && a.demar.toLowerCase().includes(q));
  });

  if(sortState.key){
    const key = sortState.key;
    const dir = sortState.dir;
    filtered.sort((x,y)=>{
      const a = (x[key] === null || x[key] === undefined) ? '' : x[key];
      const b = (y[key] === null || y[key] === undefined) ? '' : y[key];
      if(typeof a === 'number' || typeof b === 'number'){
        return (Number(a) - Number(b)) * dir;
      }
      return String(a).localeCompare(String(b), 'fr', {numeric:true}) * dir;
    });
  }

  renderTable();
  updateStats();
}

/* ============ Stats ============ */
function updateStats(){
  const count = filtered.length;
  const prixSum = filtered.reduce((s, a)=> s + (Number(a.prix_vente)||0), 0);
  const prixAvg = count ? (prixSum / count) : 0;
  
  const valeurSum = filtered.reduce((s, a)=> {
    const prix = Number(a.prix_vente) || 0;
    const achat = Number(a.achat_minimum) || 0;
    return s + (prix * achat);
  }, 0);
  
  const valeurAvg = count ? (valeurSum / count) : 0;

  document.getElementById('statCount').textContent = count;
  document.getElementById('statAvg').textContent = count ? formatCurrency(prixAvg) : '-';
  document.getElementById('statTotal').textContent = formatCurrency(valeurSum);
  document.getElementById('statValueAvg').textContent = formatCurrency(valeurAvg);
}

/* ============ Utils sécurité ============ */
function escapeHtml(s){
  if(s === null || s === undefined) return '';
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;');
}

/* ================= API Calls ================= */

async function loadArticles(){
  try {
    setLoading(true);
    const res = await fetch(API_BASE, { headers: authHeaders() });
    if(!res.ok) throw new Error('Impossible de charger les articles');
    articles = await res.json();
    // ensure id present
    articles = articles.map(a => ({ ...a, id: a.id || a._id || a.code }));
    
    // Extraire les unités et types uniques
    const units = new Set();
    const types = new Set();
    
    articles.forEach(item => {
      if (item.unite) units.add(item.unite);
      if (item.type) types.add(item.type);
    });
    
    allUnits = Array.from(units);
    allTypes = Array.from(types);
    
    populateFilterOptions();
    applyFiltersSortSearch();
  } catch (e){
    console.error(e);
    toast('Erreur chargement articles: ' + e.message, 'err');
  } finally {
    setLoading(false);
  }
}

async function saveArticle(data, id){
  try {
    const method = id ? 'PUT' : 'POST';
    const url = id ? `${API_BASE}/${id}` : API_BASE;
    const res = await fetch(url, {
      method,
      headers: authHeaders(),
      body: JSON.stringify(data)
    });
    if(!res.ok){
      const txt = await res.text();
      throw new Error(txt || 'Erreur sauvegarde');
    }
    toast('Article enregistré');
    closeArticleModal();
    await loadArticles();
  } catch (e){
    console.error(e);
    toast('Erreur enregistrement: ' + e.message, 'err');
    throw e;
  }
}

async function deleteArticle(id){
  if(!confirm('Supprimer cet article ?')) return;
  try {
    const res = await fetch(`${API_BASE}/${id}`, { method:'DELETE', headers: authHeaders() });
    if(!res.ok) throw new Error('Erreur suppression');
    toast('Article supprimé');
    await loadArticles();
  } catch (e){
    console.error(e);
    toast('Erreur suppression: ' + e.message, 'err');
  }
}

/* ================= Modal control ================= */
function openAdd(){
  document.getElementById('modalTitle').textContent = 'Ajouter un article';
  document.getElementById('articleId').value = '';
  document.getElementById('f_code').value = '';
  document.getElementById('f_type').value = '';
  document.getElementById('f_description').value = '';
  document.getElementById('f_prix_vente').value = '';
  document.getElementById('f_achat_minimum').value = '';
  document.getElementById('f_valeur').value = '';
  document.getElementById('f_unite').value = '';
  document.getElementById('f_demar').value = '';
  showArticleModal();
}

function openEdit(id){
  const a = articles.find(x => String(x.id) === String(id));
  if(!a){ toast('Article introuvable','err'); return; }
  document.getElementById('modalTitle').textContent = 'Modifier un article';
  document.getElementById('articleId').value = a.id;
  document.getElementById('f_code').value = a.code || '';
  document.getElementById('f_type').value = a.type || '';
  document.getElementById('f_description').value = a.description || '';
  document.getElementById('f_prix_vente').value = a.prix_vente || '';
  document.getElementById('f_achat_minimum').value = a.achat_minimum || '';
  
  // Calculate and show value
  const prix = Number(a.prix_vente) || 0;
  const achat = Number(a.achat_minimum) || 0;
  document.getElementById('f_valeur').value = formatCurrency(prix * achat);
  
  document.getElementById('f_unite').value = a.unite || '';
  document.getElementById('f_demar').value = a.demar || '';
  showArticleModal();
}

function showArticleModal(){ 
  document.getElementById('modalArticle').style.display='flex'; 
  // Add event listeners for value calculation
  document.getElementById('f_prix_vente').addEventListener('input', calculateValue);
  document.getElementById('f_achat_minimum').addEventListener('input', calculateValue);
}

function calculateValue() {
  const prix = parseFloat(document.getElementById('f_prix_vente').value) || 0;
  const achat = parseFloat(document.getElementById('f_achat_minimum').value) || 0;
  const valeur = prix * achat;
  document.getElementById('f_valeur').value = formatCurrency(valeur);
}

function closeArticleModal(){ 
  document.getElementById('modalArticle').style.display='none'; 
  // Remove event listeners
  document.getElementById('f_prix_vente').removeEventListener('input', calculateValue);
  document.getElementById('f_achat_minimum').removeEventListener('input', calculateValue);
}

function showBatchModal(){ 
  document.getElementById('modalBatch').style.display='flex';
  initBatchTable();
}

function closeBatchModal(){ 
  document.getElementById('modalBatch').style.display='none'; 
}

/* ================= Form handling ================= */

function validateArticleForm(){
  const code = document.getElementById('f_code').value.trim();
  const desc = document.getElementById('f_description').value.trim();
  const prix = document.getElementById('f_prix_vente').value;

  let ok = true;
  if(!code){ 
    document.getElementById('f_code').style.borderColor = 'var(--danger)';
    ok = false; 
  }
  if(!desc){ 
    document.getElementById('f_description').style.borderColor = 'var(--danger)';
    ok = false; 
  }
  if(prix === '' || isNaN(prix)){ 
    document.getElementById('f_prix_vente').style.borderColor = 'var(--danger)';
    ok = false; 
  }

  // duplicate check: code must be unique (except if editing same id)
  const id = document.getElementById('articleId').value;
  const dup = articles.find(a => a.code && a.code.toLowerCase() === code.toLowerCase() && String(a.id) !== String(id));
  if(dup){
    document.getElementById('f_code').style.borderColor = 'var(--danger)';
    toast('Code dupliqué détecté: ' + dup.code, 'err');
    ok = false;
  }

  return ok;
}

/* ================= Batch import ================= */
function initBatchTable() {
  const tableBody = document.getElementById('batch-items-table');
  tableBody.innerHTML = '';
  
  // Ajouter 3 lignes initiales
  for (let i = 0; i < 3; i++) {
    addBatchRow();
  }
  
  // Gestion des événements
  document.getElementById('batch-add-row').addEventListener('click', addBatchRow);
  document.getElementById('batch-save-all').addEventListener('click', saveBatchData);
}

function addBatchRow() {
  const tableBody = document.getElementById('batch-items-table');
  const newRow = document.createElement('tr');
  
  newRow.innerHTML = `
    <td><input type="text" class="batch-code" placeholder="Ex: W0110-F4-08"></td>
    <td><input type="text" class="batch-desc" placeholder="Description"></td>
    <td><input type="text" class="batch-demar" placeholder="Demar"></td>
    <td><input type="number" step="0.01" min="0" class="batch-price" placeholder="0.00"></td>
    <td><input type="number" step="0.01" min="0" class="batch-min" placeholder="0"></td>
    <td><input type="text" class="batch-unit" placeholder="Unité" list="unit-list"></td>
    <td><input type="text" class="batch-type" placeholder="Type" list="type-list"></td>
    <td class="actions-cell">
      <button class="remove-btn">
        <i class="fas fa-trash-alt"></i>
      </button>
    </td>
  `;
  
  tableBody.appendChild(newRow);
  
  // Ajouter l'écouteur d'événement pour le bouton de suppression
  const removeBtn = newRow.querySelector('.remove-btn');
  removeBtn.addEventListener('click', function() {
    if (tableBody.querySelectorAll('tr').length > 1) {
      tableBody.removeChild(newRow);
    } else {
      toast('Vous devez conserver au moins une ligne', 'warn');
    }
  });
  
  // Ajouter des suggestions d'autocomplétion
  setupAutocomplete(newRow.querySelector('.batch-unit'), allUnits);
  setupAutocomplete(newRow.querySelector('.batch-type'), allTypes);
  
  // Navigation au clavier
  setupKeyboardNavigation(newRow);
}

function setupAutocomplete(inputElement, suggestions) {
  inputElement.addEventListener('input', function() {
    const value = this.value.toLowerCase();
    // Créer une datalist si elle n'existe pas
    let datalist = document.getElementById(`${inputElement.id}-list`);
    if (!datalist) {
      datalist = document.createElement('datalist');
      datalist.id = `${inputElement.id}-list`;
      document.body.appendChild(datalist);
      inputElement.setAttribute('list', datalist.id);
    }
    
    // Vider les options existantes
    datalist.innerHTML = '';
    
    if (value.length > 0) {
      // Filtrer les suggestions
      const filtered = suggestions.filter(item => 
        item.toLowerCase().includes(value)
      );
      
      // Ajouter les nouvelles options
      filtered.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        datalist.appendChild(option);
      });
    }
  });
}

function setupKeyboardNavigation(row) {
  const inputs = row.querySelectorAll('input');
  
  inputs.forEach(input => {
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        
        // Trouver l'index de l'input actuel
        const allInputs = Array.from(document.querySelectorAll('#batch-items-table input'));
        const currentIndex = allInputs.indexOf(this);
        
        // Si c'est le dernier champ de la ligne, ajouter une nouvelle ligne
        if (currentIndex === allInputs.length - 1) {
          addBatchRow();
          // Focus sur le premier champ de la nouvelle ligne
          document.querySelector('#batch-items-table tr:last-child input').focus();
        } else {
          // Sinon, passer au champ suivant
          allInputs[currentIndex + 1].focus();
        }
      }
    });
  });
}

async function saveBatchData() {
  const rows = document.querySelectorAll('#batch-items-table tr');
  let isValid = true;
  const items = [];
  const newUnits = [];
  const newTypes = [];
  
  rows.forEach(row => {
    const code = row.querySelector('.batch-code').value.trim();
    const description = row.querySelector('.batch-desc').value.trim();
    const demar = row.querySelector('.batch-demar').value.trim();
    const price = row.querySelector('.batch-price').value;
    const min = row.querySelector('.batch-min').value;
    const unit = row.querySelector('.batch-unit').value.trim();
    const type = row.querySelector('.batch-type').value.trim();
    
    // Validation des champs obligatoires
    if (!code || !description) {
      isValid = false;
      if (!code) row.querySelector('.batch-code').style.borderColor = '#e53e3e';
      if (!description) row.querySelector('.batch-desc').style.borderColor = '#e53e3e';
    } else {
      const item = {
        code,
        description,
        demar,
        prix_vente: price ? parseFloat(price) : 0,
        achat_minimum: min ? parseFloat(min) : 0,
        unite: unit,
        type
      };
      items.push(item);
      
      // Ajouter les nouvelles unités et types
      if (unit && !allUnits.includes(unit)) {
        newUnits.push(unit);
      }
      if (type && !allTypes.includes(type)) {
        newTypes.push(type);
      }
    }
  });
  
  if (!isValid) {
    toast('Veuillez remplir les champs obligatoires (CODE et DESCRIPTION) pour toutes les lignes', 'error');
    return;
  }
  
  // Envoyer les données à l'API un par un
  let successCount = 0;
  for (const item of items) {
    try {
      // Vérifier si le code existe déjà
      const exists = articles.some(a => a.code.toLowerCase() === item.code.toLowerCase());
      if (exists) {
        toast(`Ignoré (dupliqué): ${item.code}`, 'warn');
        continue;
      }
      
      const res = await fetch(API_BASE, {
        method: 'POST',
        headers: authHeaders(),
        body: JSON.stringify(item)
      });
      
      if (!res.ok) {
        const error = await res.text();
        toast(`Erreur: ${error}`, 'err');
      } else {
        successCount++;
      }
    } catch (e) {
      toast(`Erreur: ${e.message}`, 'err');
    }
  }
  
  if (successCount > 0) {
    toast(`${successCount} article(s) ajoutés avec succès`, 'success');
    
    // Mettre à jour les listes d'autocomplétion
    if (newUnits.length > 0) {
      allUnits = [...new Set([...allUnits, ...newUnits])];
    }
    if (newTypes.length > 0) {
      allTypes = [...new Set([...allTypes, ...newTypes])];
    }
    
    // Recharger les articles
    await loadArticles();
    closeBatchModal();
  }
}

/* ================= Export filtered to Excel ================= */
function exportFilteredToExcel(){
  if(!filtered.length){ toast('Aucune donnée à exporter','warn'); return; }
  const data = filtered.map(a => ({
    Code: a.code,
    Description: a.description,
    Demar: a.demar,
    'Prix Vente ($)': a.prix_vente,
    'Achat Minimum': a.achat_minimum,
    'Valeur ($)': (Number(a.prix_vente) || 0) * (Number(a.achat_minimum) || 0),
    Unite: a.unite,
    Type: a.type,
    'ID': a.id
  }));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Articles');
  XLSX.writeFile(wb, 'articles_export.xlsx');
  toast('Export terminé');
}

/* ================= Loading UI ================= */
function setLoading(is){
  const wrap = document.querySelector('.wrap');
  if(is){
    if(!document.querySelector('#spinnerOverlay')){
      const overlay = document.createElement('div');
      overlay.id = 'spinnerOverlay';
      overlay.style.position='fixed';
      overlay.style.inset='0';
      overlay.style.background='rgba(255,255,255,0.7)';
      overlay.style.zIndex='200';
      overlay.style.display='flex';
      overlay.style.alignItems='center';
      overlay.style.justifyContent='center';
      overlay.innerHTML = `
        <div style="display:flex;flex-direction:column;align-items:center">
          <div class="loading-spinner" style="width:40px;height:40px;border-width:3px;border-top-color:var(--accent)"></div>
          <div style="margin-top:16px;color:var(--text-secondary)">Chargement...</div>
        </div>
      `;
      document.body.appendChild(overlay);
    }
  } else {
    const node = document.getElementById('spinnerOverlay');
    if(node) node.remove();
  }
}

/* ================= Sorting handlers ================= */
document.querySelectorAll('thead th.sortable').forEach(th=>{
  th.style.cursor='pointer';
  th.addEventListener('click', ()=>{
    const key = th.getAttribute('data-key');
    if(sortState.key === key) sortState.dir *= -1; else { sortState.key = key; sortState.dir = 1; }
    applyFiltersSortSearch();
  });
});

/* ================= Populate filter dropdowns ================= */
function populateFilterOptions(){
  const types = Array.from(new Set(articles.map(a=>a.type).filter(Boolean))).sort();
  const demars = Array.from(new Set(articles.map(a=>a.demar).filter(Boolean))).sort();

  const tsel = document.getElementById('filterType');
  tsel.innerHTML = `<option value="">Filtrer par Type</option>`;
  types.forEach(t => tsel.innerHTML += `<option value="${escapeHtml(t)}">${t}</option>`);

  const dsel = document.getElementById('filterDemar');
  dsel.innerHTML = `<option value="">Filtrer par Démarque</option>`;
  demars.forEach(d => dsel.innerHTML += `<option value="${escapeHtml(d)}">${d}</option>`);
}

/* ================= Events binding ================= */
document.getElementById('btnAdd').addEventListener('click', openAdd);
document.getElementById('btnBatch').addEventListener('click', showBatchModal);
document.getElementById('btnExport').addEventListener('click', exportFilteredToExcel);
document.getElementById('btnRefresh').addEventListener('click', ()=>loadArticles());

document.getElementById('filterType').addEventListener('change', applyFiltersSortSearch);
document.getElementById('filterDemar').addEventListener('change', applyFiltersSortSearch);

let searchTimer = null;
document.getElementById('searchInput').addEventListener('input', ()=>{
  clearTimeout(searchTimer);
  searchTimer = setTimeout(()=> applyFiltersSortSearch(), 220);
});

/* Submit article form */
document.getElementById('articleForm').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  if(!validateArticleForm()) return;
  const id = document.getElementById('articleId').value || null;
  const data = {
    code: document.getElementById('f_code').value.trim(),
    type: document.getElementById('f_type').value.trim(),
    description: document.getElementById('f_description').value.trim(),
    prix_vente: Number(document.getElementById('f_prix_vente').value) || 0,
    achat_minimum: Number(document.getElementById('f_achat_minimum').value) || 0,
    unite: document.getElementById('f_unite').value.trim(),
    demar: document.getElementById('f_demar').value.trim(),
  };
  await saveArticle(data, id);
});

/* ================= Auto-refresh ================= */
function startAutoRefresh(){
  if(autoRefreshTimer) clearInterval(autoRefreshTimer);
  autoRefreshTimer = setInterval(()=> {
    loadArticles();
    const txt = document.getElementById('autoRefreshTxt');
    if(txt) txt.textContent = '5min (auto)';
  }, AUTO_REFRESH_MS);
}
startAutoRefresh();

/* ================= On load ================= */
(async function init(){
  await loadArticles();
  applyFiltersSortSearch();
})();
</script>
</body>
</html>