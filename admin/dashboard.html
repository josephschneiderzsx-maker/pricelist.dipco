<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DIPCO Dashboard Admin</title>

<!-- Librairies externes -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Fichiers locaux -->
<link rel="stylesheet" href="dashboard.css" />
</head>
<body>
  <script>
    if (!localStorage.getItem('token')) {
        window.location.href = 'login.html';
    }
  </script>
  <div class="wrap">
    <header class="topbar">
      <div class="branding">
        <img src="https://dipco.itxpress.net/dipco_logo.png" alt="logo">
        <div>
          <div style="font-weight:700;font-size:22px;color:var(--text-primary)">DIPCO Dashboard Admin</div>
          <div class="muted">Gestion des Articles & Prix</div>
        </div>
      </div>
      <div class="muted">Auto-refresh: <span id="autoRefreshTxt">5min</span></div>
    </header>

    <!-- Stats + controls -->
    <section class="card">
      <div class="stats">
        <div class="stat">
          <div class="label">Articles</div>
          <div class="value" id="statCount">0</div>
        </div>
        <div class="stat">
          <div class="label">Prix moyen ($)</div>
          <div class="value" id="statAvg">-</div>
        </div>
        <div class="stat">
          <div class="label">Total valeur ($)</div>
          <div class="value" id="statTotal">-</div>
        </div>
        <div class="stat">
          <div class="label">Valeur moyenne ($)</div>
          <div class="value" id="statValueAvg">-</div>
        </div>
      </div>

      <div class="controls">
        <div class="search">
          <i class="fas fa-search"></i>
          <input id="searchInput" placeholder="Recherche par code, description, type, demar..." />
        </div>

        <div class="filters">
          <select id="filterType" class="select">
            <option value="">Filtrer par Type</option>
          </select>
          <select id="filterDemar" class="select">
            <option value="">Filtrer par Démarque</option>
          </select>

          <div style="display:flex;gap:12px;align-items:center;">
            <button id="btnAdd" class="btn btn-secondary"><i class="fas fa-plus"></i> Ajouter</button>
            <button id="btnBatch" class="btn btn-excel"><i class="fas fa-layer-group"></i> Ajout en lot</button>
            <button id="btnExport" class="btn btn-secondary"><i class="fas fa-file-export"></i> Export</button>
            <button id="btnRefresh" class="btn btn-secondary" title="Forcer refresh"><i class="fas fa-sync-alt"></i></button>
          </div>
        </div>
      </div>
    </section>

    <!-- Table -->
    <section class="card">
      <div class="table-wrap">
        <table id="articlesTable">
          <thead>
            <tr>
              <th data-key="code" class="sortable">Code <i class="fas fa-sort"></i></th>
              <th data-key="description" class="sortable">Description <i class="fas fa-sort"></i></th>
              <th data-key="demar" class="sortable">Demar <i class="fas fa-sort"></i></th>
              <th data-key="prix_vente" class="sortable">Prix ($) <i class="fas fa-sort"></i></th>
              <th data-key="achat_minimum" class="sortable">Achat <i class="fas fa-sort"></i></th>
              <th>Valeur ($)</th>
              <th data-key="unite" class="sortable">Unité <i class="fas fa-sort"></i></th>
              <th data-key="type" class="sortable">Type <i class="fas fa-sort"></i></th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <!-- Rempli par JS -->
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Modal ARTICLE (Add / Edit) -->
  <div id="modalArticle" class="modal-backdrop" style="display:none;">
    <div class="modal-box">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Ajouter un article</div>
        <button onclick="closeArticleModal()" class="btn btn-secondary">Fermer</button>
      </div>

      <form id="articleForm">
        <input type="hidden" id="articleId" />
        <div class="form-grid">
          <div>
            <label>Code *</label>
            <input id="f_code" type="text" required />
            <div class="muted" style="margin-top:6px">Ex: W0110-F4-08</div>
          </div>
          <div>
            <label>Type *</label>
            <input id="f_type" type="text" required />
          </div>
          <div class="full">
            <label>Description *</label>
            <textarea id="f_description" rows="2" required></textarea>
          </div>
          <div>
            <label>Prix Vente ($) *</label>
            <input id="f_prix_vente" type="number" step="0.01" min="0" required />
          </div>
          <div>
            <label>Achat Minimum ($)</label>
            <input id="f_achat_minimum" type="number" step="0.01" min="0" />
          </div>
          <div>
            <label>Valeur ($)</label>
            <input id="f_valeur" type="text" readonly />
          </div>
          <div>
            <label>Unité</label>
            <input id="f_unite" type="text" />
          </div>
          <div>
            <label>Démarque</label>
            <input id="f_demar" type="text" />
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeArticleModal()">Annuler</button>
          <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Enregistrer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Page Plein Écran pour l'Ajout par Lot -->
  <div id="batch-add-page" style="display:none;">
    <header class="topbar">
      <div class="branding">
        <div>
          <div style="font-weight:700;font-size:22px;color:var(--text-primary)">Ajout en Lot</div>
          <div class="muted">Ajoutez ou modifiez plusieurs articles simultanément</div>
        </div>
      </div>
      <button id="btnBackToDashboard" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Retour</button>
    </header>

    <div class="card">
      <div class="batch-table-container">
        <table class="batch-table">
          <thead>
            <tr>
              <th class="required">CODE</th>
              <th class="required">DESCRIPTION</th>
              <th>DEMAR</th>
              <th>PRIX ($)</th>
              <th>ACHAT MIN.</th>
              <th>UNITÉ</th>
              <th>TYPE</th>
              <th>ACTIONS</th>
            </tr>
          </thead>
          <tbody id="batch-items-table">
            <!-- Rempli dynamiquement -->
          </tbody>
        </table>
      </div>

      <div class="batch-footer">
        <div class="batch-add-row" id="batch-add-row">
          <i class="fas fa-plus-circle"></i>
          <span>Ajouter ligne</span>
        </div>
        <div class="batch-save">
          <button class="btn btn-excel" id="batch-save-all">
            <i class="fas fa-save"></i> Enregistrer tout
          </button>
        </div>
      </div>

      <div class="batch-info">
        <i class="fas fa-info-circle" style="color: var(--accent); font-size: 24px;"></i>
        <div>
          <h4 style="font-weight: 600; margin-bottom: 8px;">Conseils pour l'ajout en lot</h4>
          <p class="muted">Commencez à taper dans les champs pour voir les suggestions basées sur les valeurs existantes. Appuyez sur Entrée pour passer à la cellule suivante.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-wrap" id="toasts"></div>

<script src="dashboard.js"></script>
</body>
</html>