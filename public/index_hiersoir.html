<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liste des Prix - Dipco</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'apple-blue': '#007AFF',
                        'apple-gray': '#8E8E93',
                        'apple-light': '#F2F2F7'
                    },
                    fontFamily: {
                        'apple': ['-apple-system', 'BlinkMacSystemFont', 'SF Pro Display', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        .highlight {
            animation: highlight 0.6s ease-out;
        }
        
        @keyframes highlight {
            0% { background-color: rgba(0, 122, 255, 0.1); }
            100% { background-color: transparent; }
        }
        
        .table-scroll::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }
        
        .table-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .table-scroll::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }
    </style>
</head>
<body class="font-apple bg-white text-black">
    
    <!-- Single Row Header -->
    <div class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16 gap-4">
                
                <!-- Logo & Title -->
                <div class="flex items-center gap-3 min-w-0 flex-shrink-0">
                    <img src="https://dipco.itxpress.net/dipco_logo.png" 
                         alt="Dipco" 
                         class="h-8 w-auto"
                         onerror="this.style.display='none'">
                    <h1 class="text-lg font-semibold text-black hidden sm:block">
                        Liste des Prix
                    </h1>
                </div>

                <!-- Search & Filters -->
                <div class="flex-1 max-w-4xl mx-4">
                    <div class="flex flex-col sm:flex-row gap-2">
                        <!-- Search Input -->
                        <div class="relative flex-1">
                            <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <input type="text" 
                                   id="searchInput" 
                                   class="w-full pl-10 pr-4 py-2 bg-gray-100 border-0 rounded-lg text-sm placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-apple-blue focus:bg-white transition-all duration-200" 
                                   placeholder="Rechercher...">
                        </div>
                        
                        <!-- Filters Row -->
                        <div class="flex gap-2">
                            <!-- Type Filter -->
                            <select id="typeFilter" class="px-3 py-2 bg-gray-100 border-0 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-apple-blue focus:bg-white transition-all duration-200">
                                <option value="">Tous types</option>
                            </select>
                            
                            <!-- Demar Filter -->
                            <select id="demarFilter" class="px-3 py-2 bg-gray-100 border-0 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-apple-blue focus:bg-white transition-all duration-200">
                                <option value="">Tous Demar.</option>
                            </select>
                            
                            <!-- Sort Options -->
                            <select id="sortOptions" class="px-3 py-2 bg-gray-100 border-0 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-apple-blue focus:bg-white transition-all duration-200">
                                <option value="default">Tri par défaut</option>
                                <option value="code-asc">Code A-Z</option>
                                <option value="code-desc">Code Z-A</option>
                                <option value="price-asc">Prix croissant</option>
                                <option value="price-desc">Prix décroissant</option>
                                <option value="desc-asc">Description A-Z</option>
                                <option value="desc-desc">Description Z-A</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Stats -->
                <div class="flex items-center gap-3 flex-shrink-0">
                    <div class="hidden md:flex items-center gap-4 text-sm text-gray-600">
                        <span id="article-count">0 articles</span>
                        <span id="last-update">—</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="hidden flex items-center justify-center py-20">
        <div class="flex items-center gap-3">
            <div class="w-5 h-5 border-2 border-apple-blue/30 border-t-apple-blue rounded-full animate-spin"></div>
            <span class="text-gray-600">Chargement...</span>
        </div>
    </div>

    <!-- Error Message -->
    <div id="error-message" class="hidden mx-4 mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
        <div class="flex items-center gap-3">
            <div class="w-5 h-5 bg-red-500 rounded-full flex items-center justify-center">
                <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
            </div>
            <span class="text-red-800 text-sm font-medium"></span>
        </div>
    </div>

    <!-- Table Container -->
    <div class="table-scroll overflow-auto" style="height: calc(100vh - 64px);">
        <table class="min-w-full">
            <thead class="sticky top-0 z-10 bg-gray-50">
                <tr class="border-b border-gray-200">
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Code
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Description
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">
                       Demar.
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Prix
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">
                        Achat Min
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden lg:table-cell">
                        Unité
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Type
                    </th>
                </tr>
            </thead>
            <tbody id="articles-table" class="divide-y divide-gray-200">
                <!-- Contenu généré par JavaScript -->
            </tbody>
        </table>
    </div>

    <script>
        let allArticles = [];



        // Fonction pour charger les articles depuis l'API
        async function loadArticles() {
            try {
                showLoading(true);     
                const response = await fetch('https://dipco.itxpress.net/api/public/articles');
                if (!response.ok) throw new Error('Impossible de charger les données');
                const articles = await response.json();
                allArticles = articles;
                populateFilters(articles);
                renderArticles(articles);
                updateStats(articles.length);
                showLoading(false);
                updateLastUpdateTime();
            } catch (error) {
                showError(error.message);
            }
        }

        // Fonction pour peupler les filtres avec les valeurs uniques
        function populateFilters(articles) {
            // Récupérer les types uniques
            const types = [...new Set(articles.map(article => article.type).filter(Boolean))].sort();
            const typeFilter = document.getElementById('typeFilter');
            typeFilter.innerHTML = '<option value="">Tous types</option>';
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeFilter.appendChild(option);
            });

            // Récupérer les démarrages uniques
            const demars = [...new Set(articles.map(article => article.demar).filter(Boolean))].sort();
            const demarFilter = document.getElementById('demarFilter');
            demarFilter.innerHTML = '<option value="">Tous Demar.</option>';
            demars.forEach(demar => {
                const option = document.createElement('option');
                option.value = demar;
                option.textContent = demar;
                demarFilter.appendChild(option);
            });
        }

        // Fonction pour filtrer et trier les articles
        function filterAndSortArticles() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            const selectedType = document.getElementById('typeFilter').value;
            const selectedDemar = document.getElementById('demarFilter').value;
            const sortOption = document.getElementById('sortOptions').value;

            let filteredArticles = allArticles.filter(article => {
                // Filtre de recherche textuelle
                const searchText = `${article.code || ''} ${article.description || ''} ${article.type || ''}`.toLowerCase();
                const matchesSearch = searchText.includes(searchTerm);

                // Filtre par type
                const matchesType = !selectedType || article.type === selectedType;

                // Filtre par démarrage
                const matchesDemar = !selectedDemar || article.demar === selectedDemar;

                return matchesSearch && matchesType && matchesDemar;
            });

            // Tri des articles
            switch (sortOption) {
                case 'code-asc':
                    filteredArticles.sort((a, b) => (a.code || '').localeCompare(b.code || ''));
                    break;
                case 'code-desc':
                    filteredArticles.sort((a, b) => (b.code || '').localeCompare(a.code || ''));
                    break;
                case 'price-asc':
                    filteredArticles.sort((a, b) => (a.prix_vente || 0) - (b.prix_vente || 0));
                    break;
                case 'price-desc':
                    filteredArticles.sort((a, b) => (b.prix_vente || 0) - (a.prix_vente || 0));
                    break;
                case 'desc-asc':
                    filteredArticles.sort((a, b) => (a.description || '').localeCompare(b.description || ''));
                    break;
                case 'desc-desc':
                    filteredArticles.sort((a, b) => (b.description || '').localeCompare(a.description || ''));
                    break;
                default:
                    // Tri par défaut (ordre original)
                    break;
            }

            renderArticles(filteredArticles);
            updateStats(filteredArticles.length);

            // Mise en évidence pour la recherche
            if (searchTerm && searchTerm.length > 2) {
                setTimeout(() => {
                    document.querySelectorAll('#articles-table tr').forEach(row => {
                        row.classList.add('highlight');
                        setTimeout(() => row.classList.remove('highlight'), 800);
                    });
                }, 100);
            }
        }

        // Fonction pour afficher les articles dans le tableau
        function renderArticles(articles) {
            const table = document.getElementById('articles-table');
            table.innerHTML = '';
            
            if (articles.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-12 text-center">
                            <div class="text-4xl mb-4">📦</div>
                            <p class="text-lg font-medium text-gray-900 mb-2">Aucun article</p>
                            <p class="text-gray-500 text-sm">Aucun résultat trouvé</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            articles.forEach((article, index) => {
                const row = document.createElement('tr');
                row.className = `hover:bg-gray-50 transition-colors duration-150 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50/50'}`;
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="text-sm font-mono font-medium text-black">${article.code || '—'}</span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="text-sm text-black">${article.description || '—'}</span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap hidden sm:table-cell">
                        <span class="text-sm text-gray-600">${article.demar || '—'}</span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="text-sm font-semibold text-apple-blue">${formatCurrency(article.prix_vente)}</span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap hidden md:table-cell">
                        <span class="text-sm text-gray-600">${formatDecimal(article.achat_minimum)}</span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap hidden lg:table-cell">
                        <span class="text-sm text-gray-600">${article.unite || '—'}</span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="inline-block px-2 py-1 text-xs font-medium bg-gray-100 text-gray-700 rounded">
                            ${article.type || '—'}
                        </span>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        // Fonction pour formater les prix en devise
        function formatCurrency(value) {
            if (!value && value !== 0) return '—';
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(value);
        }

        // Fonction pour formater les nombres décimaux
        function formatDecimal(value) {
            if (!value && value !== 0) return '—';
            return new Intl.NumberFormat('fr-FR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        // Fonction pour afficher/masquer le spinner de chargement
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.remove('hidden');
            } else {
                loading.classList.add('hidden');
            }
        }

        // Fonction pour afficher les messages d'erreur
        function showError(message) {
            const errorMsg = document.getElementById('error-message');
            const errorText = errorMsg.querySelector('span');
            errorText.textContent = message;
            errorMsg.classList.remove('hidden');
            showLoading(false);
        }

        // Mettre à jour les statistiques
        function updateStats(count) {
            document.getElementById('article-count').textContent = `${count} article${count > 1 ? 's' : ''}`;
        }

        // Mettre à jour l'heure de dernière mise à jour
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            document.getElementById('last-update').textContent = timeString;
        }

        // Événements pour tous les filtres et la recherche
        document.getElementById('searchInput').addEventListener('input', filterAndSortArticles);
        document.getElementById('typeFilter').addEventListener('change', filterAndSortArticles);
        document.getElementById('demarFilter').addEventListener('change', filterAndSortArticles);
        document.getElementById('sortOptions').addEventListener('change', filterAndSortArticles);

        // Initialisation
        window.addEventListener('DOMContentLoaded', function() {
            loadArticles();
        });

        // Actualisation périodique des données
        setInterval(loadArticles, 300000); // Actualise toutes les 5 minutes
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96c493f842bbbc83',t:'MTc1NDcxNDQ1My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
